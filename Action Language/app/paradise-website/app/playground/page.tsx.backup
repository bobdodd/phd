'use client';

import { useState, useEffect } from 'react';
import dynamic from 'next/dynamic';

// Dynamically import Monaco to avoid SSR issues
const MonacoEditor = dynamic(() => import('@monaco-editor/react'), { ssr: false });

// Example code snippets - now with multi-file support
const EXAMPLES = {
  'mouse-only-click': {
    title: 'Mouse-Only Click Handler',
    description: 'Click handler without keyboard support (WCAG 2.1.1)',
    category: 'js-only',
    files: {
      html: '',
      javascript: `const button = document.getElementById('submit');

button.addEventListener('click', function() {
  console.log('Form submitted');
  submitForm();
});

// Missing keyboard handler!`,
      css: ''
    },
    issues: ['mouse-only-click']
  },
  'cross-file-handlers': {
    title: 'Cross-File Handlers (Multi-Model)',
    description: 'Handlers split across files - eliminates false positives',
    category: 'multi-model',
    files: {
      html: `<button id="submitButton" class="primary-btn">
  Submit Form
</button>`,
      javascript: `// click-handlers.js
document.getElementById('submitButton')
  .addEventListener('click', function() {
    submitForm();
  });

// keyboard-handlers.js (separate file)
document.getElementById('submitButton')
  .addEventListener('keydown', function(e) {
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      submitForm();
    }
  });`,
      css: `.primary-btn {
  padding: 10px 20px;
  background: #4f46e5;
  color: white;
  border: none;
  border-radius: 5px;
}

.primary-btn:focus {
  outline: 2px solid #818cf8;
  outline-offset: 2px;
}`
    },
    issues: []
  },
  'orphaned-handler': {
    title: 'Orphaned Event Handler',
    description: 'Handler attached to non-existent element (typo)',
    category: 'multi-model',
    files: {
      html: `<button id="submitButton">Submit</button>
<button id="cancelButton">Cancel</button>`,
      javascript: `// Typo: "sumbit" instead of "submit"
document.getElementById('sumbitButton')
  .addEventListener('click', function() {
    console.log('Submit clicked');
  });

// Correct
document.getElementById('cancelButton')
  .addEventListener('click', function() {
    console.log('Cancel clicked');
  });`,
      css: ''
    },
    issues: ['orphaned-handler']
  },
  'missing-aria-target': {
    title: 'Missing ARIA Connection',
    description: 'aria-labelledby points to non-existent element',
    category: 'multi-model',
    files: {
      html: `<button aria-labelledby="submitLabel">
  Submit
</button>

<!-- Missing element with id="submitLabel" -->`,
      javascript: '',
      css: ''
    },
    issues: ['missing-aria-connection']
  },
  'css-hidden-focusable': {
    title: 'CSS Visibility Conflict',
    description: 'Focusable element hidden by CSS',
    category: 'multi-model',
    files: {
      html: `<button id="hiddenButton" tabindex="0">
  Click me
</button>`,
      javascript: `document.getElementById('hiddenButton')
  .addEventListener('click', function() {
    alert('Clicked!');
  });`,
      css: `#hiddenButton {
  display: none;  /* Hidden but still focusable! */
}

/* Alternative conflicts: */
/* visibility: hidden; */
/* opacity: 0; */`
    },
    issues: ['visibility-focus-conflict']
  },
  'focus-order-chaos': {
    title: 'Chaotic Focus Order',
    description: 'Positive tabindex disrupts natural flow',
    category: 'multi-model',
    files: {
      html: `<form>
  <input type="text" placeholder="Name" />
  <button tabindex="10">Submit</button>
  <input type="email" placeholder="Email" tabindex="5" />
  <input type="tel" placeholder="Phone" tabindex="3" />
</form>`,
      javascript: '',
      css: `form {
  display: flex;
  flex-direction: column;
  gap: 10px;
}`
    },
    issues: ['focus-order-conflict']
  },
  'positive-tabindex': {
    title: 'Positive tabIndex',
    description: 'Positive tabIndex disrupts natural tab order (WCAG 2.4.3)',
    category: 'js-only',
    files: {
      html: '',
      javascript: `const modal = document.getElementById('modal');

// Bad: positive tabIndex
modal.tabIndex = 5;

const closeBtn = modal.querySelector('.close');
closeBtn.tabIndex = 6;`,
      css: ''
    },
    issues: ['positive-tabindex']
  },
  'static-aria': {
    title: 'Static ARIA State',
    description: 'ARIA state never updated (WCAG 4.1.2)',
    category: 'js-only',
    files: {
      html: '',
      javascript: `const accordion = document.getElementById('accordion');
const button = accordion.querySelector('button');

// Set aria-expanded but never update it
button.setAttribute('aria-expanded', 'false');

button.addEventListener('click', function() {
  const panel = accordion.querySelector('.panel');
  panel.hidden = !panel.hidden;
  // Forgot to update aria-expanded!
});`,
      css: ''
    },
    issues: ['static-aria-state']
  },
  'focus-trap': {
    title: 'Focus Trap Without Escape',
    description: 'Tab trap without Escape key handler (WCAG 2.1.2)',
    category: 'js-only',
    files: {
      html: '',
      javascript: `const modal = document.getElementById('modal');
const firstBtn = modal.querySelector('button:first-child');
const lastBtn = modal.querySelector('button:last-child');

modal.addEventListener('keydown', function(event) {
  if (event.key === 'Tab') {
    if (event.shiftKey && document.activeElement === firstBtn) {
      event.preventDefault();
      lastBtn.focus();
    } else if (!event.shiftKey && document.activeElement === lastBtn) {
      event.preventDefault();
      firstBtn.focus();
    }
  }
  // No handler for the ESC key!
});`,
      css: ''
    },
    issues: ['missing-escape-handler']
  },
  'accessible-button': {
    title: 'Accessible Button (Good)',
    description: 'Proper button with keyboard and mouse support',
    category: 'js-only',
    files: {
      html: '',
      javascript: `const button = document.getElementById('submit');

// Mouse support
button.addEventListener('click', handleSubmit);

// Keyboard support
button.addEventListener('keydown', function(event) {
  if (event.key === 'Enter' || event.key === ' ') {
    event.preventDefault();
    handleSubmit(event);
  }
});

function handleSubmit(event) {
  console.log('Form submitted');
  submitForm();
}`,
      css: ''
    },
    issues: []
  }
};

export default function Playground() {
  const [selectedExample, setSelectedExample] = useState('cross-file-handlers');
  const [files, setFiles] = useState(EXAMPLES['cross-file-handlers'].files);
  const [activeFileTab, setActiveFileTab] = useState<'html' | 'javascript' | 'css'>('javascript');
  const [actionLanguage, setActionLanguage] = useState<any[]>([]);
  const [issues, setIssues] = useState<any[]>([]);
  const [activeResultTab, setActiveResultTab] = useState<'actionlanguage' | 'issues' | 'visualization'>('issues');
  const [isAnalyzing, setIsAnalyzing] = useState(false);
  const [showModels, setShowModels] = useState(true);

  // Analyze code whenever files change
  useEffect(() => {
    const timer = setTimeout(() => {
      analyzeFiles(files);
    }, 500); // Debounce

    return () => clearTimeout(timer);
  }, [files]);

  const analyzeFiles = (currentFiles: typeof files) => {
    setIsAnalyzing(true);

    try {
      // CREATE: Parse JavaScript to ActionLanguage
      const parsed = parseToActionLanguage(currentFiles.javascript);
      setActionLanguage(parsed);

      // READ: Analyze for issues (multi-model aware)
      const detected = detectIssues(parsed, currentFiles);
      setIssues(detected);
    } catch (error) {
      console.error('Analysis error:', error);
    } finally {
      setIsAnalyzing(false);
    }
  };

  const parseToActionLanguage = (code: string) => {
    // Simplified parser - in production, use Acorn/Babel
    const nodes: any[] = [];

    // Detect addEventListener with key checks in handler body
    const addEventListenerRegex = /(\w+)\.addEventListener\(['"](\w+)['"],\s*function\([^)]*\)\s*\{([^}]+(?:\{[^}]*\}[^}]*)*)\}/g;
    let match;
    while ((match = addEventListenerRegex.exec(code)) !== null) {
      const element = match[1];
      const event = match[2];
      const handlerBody = match[3];

      // For keydown handlers, detect which keys are checked
      const keysChecked: string[] = [];
      if (event === 'keydown' || event === 'keypress') {
        const keyCheckRegex = /event\.key\s*===\s*['"](\w+)['"]/g;
        let keyMatch;
        while ((keyMatch = keyCheckRegex.exec(handlerBody)) !== null) {
          keysChecked.push(keyMatch[1]);
        }
      }

      nodes.push({
        id: `node-${nodes.length + 1}`,
        actionType: 'eventHandler',
        event: event,
        element: { binding: element },
        keysChecked: keysChecked.length > 0 ? keysChecked : undefined,
        location: { line: code.substring(0, match.index).split('\n').length, column: 0 }
      });
    }

    // Detect tabIndex
    const tabIndexRegex = /(\w+)\.tabIndex\s*=\s*(\d+)/g;
    while ((match = tabIndexRegex.exec(code)) !== null) {
      nodes.push({
        id: `node-${nodes.length + 1}`,
        actionType: 'tabIndexChange',
        element: { binding: match[1] },
        newValue: parseInt(match[2]),
        location: { line: code.substring(0, match.index).split('\n').length, column: 0 }
      });
    }

    // Detect setAttribute('aria-*')
    const ariaRegex = /(\w+)\.setAttribute\(['"]aria-(\w+)['"]/g;
    while ((match = ariaRegex.exec(code)) !== null) {
      nodes.push({
        id: `node-${nodes.length + 1}`,
        actionType: 'ariaStateChange',
        element: { binding: match[1] },
        attribute: `aria-${match[2]}`,
        location: { line: code.substring(0, match.index).split('\n').length, column: 0 }
      });
    }

    return nodes;
  };

  const detectIssues = (nodes: any[], currentFiles: typeof files) => {
    const detected: any[] = [];

    // Extract element IDs from HTML
    const htmlElementIds = new Set<string>();
    if (currentFiles.html) {
      const idMatches = currentFiles.html.matchAll(/id=["']([^"']+)["']/g);
      for (const match of idMatches) {
        htmlElementIds.add(match[1]);
      }
    }

    // Orphaned handler detection (Multi-Model)
    for (const node of nodes) {
      if (node.actionType === 'eventHandler' && currentFiles.html) {
        // Extract getElementById/querySelector calls
        const getElementMatches = currentFiles.javascript.matchAll(/getElementById\(['"]([^'"]+)['"]\)/g);
        for (const match of getElementMatches) {
          const targetId = match[1];
          if (!htmlElementIds.has(targetId)) {
            // Check for typos
            const suggestions = Array.from(htmlElementIds).filter(id =>
              levenshteinDistance(id, targetId) <= 2
            );

            detected.push({
              type: 'orphaned-handler',
              severity: 'error',
              wcag: ['4.1.2'],
              message: `Handler attached to non-existent element '${targetId}'${suggestions.length > 0 ? `. Did you mean: ${suggestions.join(', ')}?` : ''}`,
              node: node
            });
          }
        }
      }
    }

    // Missing ARIA connection detection (Multi-Model)
    if (currentFiles.html) {
      const ariaMatches = currentFiles.html.matchAll(/aria-(labelledby|describedby|controls)=["']([^"']+)["']/g);
      for (const match of ariaMatches) {
        const attr = match[1];
        const targetIds = match[2].split(/\s+/);
        for (const targetId of targetIds) {
          if (!htmlElementIds.has(targetId)) {
            detected.push({
              type: 'missing-aria-connection',
              severity: 'error',
              wcag: ['1.3.1', '4.1.2'],
              message: `aria-${attr} references non-existent element '${targetId}'`,
              node: null
            });
          }
        }
      }
    }

    // CSS visibility conflict detection (Multi-Model)
    if (currentFiles.css && currentFiles.html) {
      const hiddenSelectors: string[] = [];
      const cssHiddenMatches = currentFiles.css.matchAll(/(#[\w-]+|\.[\w-]+|\w+)\s*\{[^}]*(?:display:\s*none|visibility:\s*hidden|opacity:\s*0)[^}]*\}/g);
      for (const match of cssHiddenMatches) {
        hiddenSelectors.push(match[1]);
      }

      for (const selector of hiddenSelectors) {
        // Check if this element is focusable in HTML
        if (selector.startsWith('#')) {
          const id = selector.slice(1);
          const focusableMatch = currentFiles.html.match(new RegExp(`id=["']${id}["'][^>]*(?:tabindex=|<button|<a|<input)`));
          if (focusableMatch) {
            detected.push({
              type: 'visibility-focus-conflict',
              severity: 'error',
              wcag: ['2.4.7'],
              message: `Element '${selector}' is focusable but hidden by CSS`,
              node: null
            });
          }
        }
      }
    }

    // Focus order conflict detection (Multi-Model)
    if (currentFiles.html) {
      const tabindexMatches = Array.from(currentFiles.html.matchAll(/tabindex=["'](\d+)["']/g));
      const positiveTabindices = tabindexMatches
        .map(m => parseInt(m[1]))
        .filter(val => val > 0);

      if (positiveTabindices.length > 0) {
        // Check for non-sequential or duplicate values
        const sorted = [...positiveTabindices].sort((a, b) => a - b);
        const hasDuplicates = sorted.some((val, idx) => idx > 0 && val === sorted[idx - 1]);
        const nonSequential = sorted.some((val, idx) => idx > 0 && val !== sorted[idx - 1] + 1);

        if (hasDuplicates || nonSequential || positiveTabindices.length > 2) {
          detected.push({
            type: 'focus-order-conflict',
            severity: 'warning',
            wcag: ['2.4.3'],
            message: `Chaotic tabindex values: [${positiveTabindices.join(', ')}]. Use tabindex="0" or "-1" instead.`,
            node: null
          });
        }
      }
    }

    // Mouse-only click detection (works with or without HTML)
    const clickHandlers = nodes.filter(n => n.actionType === 'eventHandler' && n.event === 'click');
    for (const click of clickHandlers) {
      const hasKeyboard = nodes.some(n =>
        n.actionType === 'eventHandler' &&
        n.element.binding === click.element.binding &&
        (n.event === 'keydown' || n.event === 'keypress')
      );

      if (!hasKeyboard) {
        detected.push({
          type: 'mouse-only-click',
          severity: 'warning',
          wcag: ['2.1.1'],
          message: `Click handler on '${click.element.binding}' without keyboard equivalent`,
          node: click
        });
      }
    }

    // Positive tabIndex detection
    const tabIndexChanges = nodes.filter(n => n.actionType === 'tabIndexChange');
    for (const change of tabIndexChanges) {
      if (change.newValue > 0) {
        detected.push({
          type: 'positive-tabindex',
          severity: 'warning',
          wcag: ['2.4.3'],
          message: `Positive tabIndex (${change.newValue}) on '${change.element.binding}' disrupts natural tab order`,
          node: change
        });
      }
    }

    // Static ARIA state detection
    const ariaChanges = nodes.filter(n => n.actionType === 'ariaStateChange');
    const ariaCounts = new Map();
    for (const change of ariaChanges) {
      const key = `${change.element.binding}-${change.attribute}`;
      ariaCounts.set(key, (ariaCounts.get(key) || 0) + 1);
    }

    for (const change of ariaChanges) {
      const key = `${change.element.binding}-${change.attribute}`;
      if (ariaCounts.get(key) === 1) {
        detected.push({
          type: 'static-aria-state',
          severity: 'warning',
          wcag: ['4.1.2'],
          message: `${change.attribute} on '${change.element.binding}' set once but never updated`,
          node: change
        });
      }
    }

    // Focus trap without escape - analyze ActionLanguage tree
    const keydownHandlers = nodes.filter(n => n.actionType === 'eventHandler' && n.event === 'keydown');
    for (const handler of keydownHandlers) {
      // Check if this handler handles Tab but not Escape
      if (handler.keysChecked && handler.keysChecked.includes('Tab') && !handler.keysChecked.includes('Escape')) {
        detected.push({
          type: 'missing-escape-handler',
          severity: 'error',
          wcag: ['2.1.2'],
          message: `Focus trap on '${handler.element.binding}' handles Tab but missing Escape key handler`,
          node: handler
        });
      }
    }

    return detected;
  };

  const loadExample = (exampleKey: string) => {
    const example = EXAMPLES[exampleKey as keyof typeof EXAMPLES];
    setFiles(example.files);
    setSelectedExample(exampleKey);

    // Set active tab based on which file has content
    if (example.files.html) setActiveFileTab('html');
    else if (example.files.javascript) setActiveFileTab('javascript');
    else if (example.files.css) setActiveFileTab('css');
  };

  const updateFile = (fileType: 'html' | 'javascript' | 'css', content: string) => {
    setFiles(prev => ({
      ...prev,
      [fileType]: content
    }));
  };

  // Helper: Levenshtein distance for typo detection
  const levenshteinDistance = (str1: string, str2: string): number => {
    const matrix: number[][] = [];

    for (let i = 0; i <= str2.length; i++) {
      matrix[i] = [i];
    }

    for (let j = 0; j <= str1.length; j++) {
      matrix[0][j] = j;
    }

    for (let i = 1; i <= str2.length; i++) {
      for (let j = 1; j <= str1.length; j++) {
        if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
          matrix[i][j] = matrix[i - 1][j - 1];
        } else {
          matrix[i][j] = Math.min(
            matrix[i - 1][j - 1] + 1,
            matrix[i][j - 1] + 1,
            matrix[i - 1][j] + 1
          );
        }
      }
    }

    return matrix[str2.length][str1.length];
  };

  return (
    <main className="min-h-screen bg-gradient-to-b from-white to-gray-50">
      {/* Hero */}
      <section className="bg-gradient-to-r from-paradise-green to-paradise-blue text-white py-12">
        <div className="container mx-auto px-6">
          <h1 className="text-4xl font-bold mb-4">Interactive Playground</h1>
          <p className="text-xl">
            See Paradise in action. Edit code and watch ActionLanguage + analysis update in real-time.
          </p>
        </div>
      </section>

      {/* Main Playground */}
      <section className="container mx-auto px-6 py-8">
        <div className="grid lg:grid-cols-2 gap-6">

          {/* Left: Code Editor */}
          <div className="space-y-4">
            <div className="bg-white rounded-lg shadow-lg p-4">
              <div className="flex items-center justify-between mb-4">
                <h2 className="text-xl font-bold">JavaScript Code</h2>
                {isAnalyzing && (
                  <span className="text-sm text-paradise-blue animate-pulse">Analyzing...</span>
                )}
              </div>

              {/* Example Selector */}
              <div className="mb-4">
                <label className="block text-sm font-semibold mb-2">Load Example:</label>
                <select
                  value={selectedExample}
                  onChange={(e) => loadExample(e.target.value)}
                  className="w-full p-2 border border-gray-300 rounded-lg bg-white"
                >
                  {Object.entries(EXAMPLES).map(([key, ex]) => (
                    <option key={key} value={key}>{ex.title}</option>
                  ))}
                </select>
                <p className="text-sm text-gray-600 mt-1">
                  {EXAMPLES[selectedExample as keyof typeof EXAMPLES].description}
                </p>
              </div>

              {/* Monaco Editor */}
              <div className="border border-gray-300 rounded-lg overflow-hidden">
                <MonacoEditor
                  height="400px"
                  defaultLanguage="javascript"
                  value={code}
                  onChange={(value) => setCode(value || '')}
                  theme="vs-light"
                  options={{
                    minimap: { enabled: false },
                    fontSize: 14,
                    lineNumbers: 'on',
                    scrollBeyondLastLine: false,
                    automaticLayout: true
                  }}
                />
              </div>
            </div>

            {/* CRUD Pipeline Visualization */}
            <div className="bg-gradient-to-r from-paradise-green/10 via-paradise-blue/10 to-paradise-orange/10 rounded-lg p-6 border border-paradise-blue/20">
              <h3 className="text-lg font-bold mb-4">CRUD Pipeline</h3>
              <div className="space-y-3">
                <div className="flex items-center gap-3">
                  <div className="bg-paradise-green text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                    C
                  </div>
                  <div className="flex-1">
                    <div className="font-semibold">CREATE (Parse)</div>
                    <div className="text-sm text-gray-600">
                      JavaScript ‚Üí {actionLanguage.length} ActionLanguage nodes
                    </div>
                  </div>
                </div>

                <div className="flex items-center gap-3">
                  <div className="bg-paradise-blue text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                    R
                  </div>
                  <div className="flex-1">
                    <div className="font-semibold">READ (Analyze)</div>
                    <div className="text-sm text-gray-600">
                      {issues.length} issues detected
                    </div>
                  </div>
                </div>

                <div className="flex items-center gap-3">
                  <div className="bg-paradise-orange text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                    U
                  </div>
                  <div className="flex-1">
                    <div className="font-semibold">UPDATE (Fix)</div>
                    <div className="text-sm text-gray-600">
                      Ready to generate fixes
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          {/* Right: Analysis Results */}
          <div className="space-y-4">

            {/* Tabs */}
            <div className="bg-white rounded-lg shadow-lg p-4">
              <div className="flex gap-2 mb-4 border-b">
                <button
                  onClick={() => setActiveTab('actionlanguage')}
                  className={`px-4 py-2 font-semibold transition-colors ${
                    activeTab === 'actionlanguage'
                      ? 'text-paradise-blue border-b-2 border-paradise-blue'
                      : 'text-gray-600 hover:text-paradise-blue'
                  }`}
                >
                  ActionLanguage ({actionLanguage.length})
                </button>
                <button
                  onClick={() => setActiveTab('issues')}
                  className={`px-4 py-2 font-semibold transition-colors ${
                    activeTab === 'issues'
                      ? 'text-paradise-orange border-b-2 border-paradise-orange'
                      : 'text-gray-600 hover:text-paradise-orange'
                  }`}
                >
                  Issues ({issues.length})
                </button>
                <button
                  onClick={() => setActiveTab('crud')}
                  className={`px-4 py-2 font-semibold transition-colors ${
                    activeTab === 'crud'
                      ? 'text-paradise-green border-b-2 border-paradise-green'
                      : 'text-gray-600 hover:text-paradise-green'
                  }`}
                >
                  CRUD Flow
                </button>
              </div>

              {/* ActionLanguage Tab */}
              {activeTab === 'actionlanguage' && (
                <div className="space-y-4">
                  <div className="bg-paradise-green/10 border-l-4 border-paradise-green p-4 rounded-r">
                    <h3 className="font-bold mb-2">CREATE Output</h3>
                    <p className="text-sm text-gray-700">
                      Your JavaScript code transformed into {actionLanguage.length} ActionLanguage nodes:
                    </p>
                  </div>

                  {actionLanguage.length === 0 ? (
                    <div className="text-center py-8 text-gray-500">
                      No ActionLanguage nodes detected. Try loading an example above.
                    </div>
                  ) : (
                    <div className="space-y-3 max-h-[500px] overflow-y-auto">
                      {actionLanguage.map((node, idx) => (
                        <div key={idx} className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                          <div className="flex items-start justify-between mb-2">
                            <span className="font-mono text-sm bg-paradise-green/20 px-2 py-1 rounded">
                              {node.actionType}
                            </span>
                            <span className="text-xs text-gray-500">
                              Line {node.location?.line}
                            </span>
                          </div>
                          <pre className="text-xs bg-white p-3 rounded overflow-x-auto">
                            {JSON.stringify(node, null, 2)}
                          </pre>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* Issues Tab */}
              {activeTab === 'issues' && (
                <div className="space-y-4">
                  <div className="bg-paradise-orange/10 border-l-4 border-paradise-orange p-4 rounded-r">
                    <h3 className="font-bold mb-2">READ Output</h3>
                    <p className="text-sm text-gray-700">
                      Analyzers detected {issues.length} accessibility {issues.length === 1 ? 'issue' : 'issues'}:
                    </p>
                  </div>

                  {issues.length === 0 ? (
                    <div className="bg-paradise-green/10 border border-paradise-green rounded-lg p-6 text-center">
                      <div className="text-4xl mb-2">‚úÖ</div>
                      <div className="font-bold text-paradise-green mb-1">No Issues Found!</div>
                      <div className="text-sm text-gray-700">
                        This code follows accessibility best practices.
                      </div>
                    </div>
                  ) : (
                    <div className="space-y-3 max-h-[500px] overflow-y-auto">
                      {issues.map((issue, idx) => (
                        <div key={idx} className={`rounded-lg p-4 border-l-4 ${
                          issue.severity === 'error'
                            ? 'bg-red-50 border-red-500'
                            : 'bg-yellow-50 border-yellow-500'
                        }`}>
                          <div className="flex items-start justify-between mb-2">
                            <span className="font-mono text-sm bg-white px-2 py-1 rounded">
                              {issue.type}
                            </span>
                            <span className="text-xs text-gray-600">
                              {issue.severity.toUpperCase()}
                            </span>
                          </div>
                          <p className="text-sm font-semibold mb-2">{issue.message}</p>
                          <div className="text-xs text-gray-600">
                            WCAG: {issue.wcag.join(', ')}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {/* CRUD Flow Tab */}
              {activeTab === 'crud' && (
                <div className="space-y-4">
                  <div className="bg-paradise-blue/10 border-l-4 border-paradise-blue p-4 rounded-r">
                    <h3 className="font-bold mb-2">Complete CRUD Pipeline</h3>
                    <p className="text-sm text-gray-700">
                      Watch how your code flows through all stages:
                    </p>
                  </div>

                  <div className="space-y-4">
                    {/* CREATE */}
                    <div className="bg-white rounded-lg p-4 border border-paradise-green">
                      <div className="flex items-center gap-2 mb-2">
                        <div className="bg-paradise-green text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs">
                          C
                        </div>
                        <h4 className="font-bold">CREATE (Parse)</h4>
                      </div>
                      <div className="text-sm text-gray-700 mb-2">
                        Source code ‚Üí ActionLanguage
                      </div>
                      <div className="text-xs bg-gray-50 p-2 rounded">
                        Generated {actionLanguage.length} nodes: {actionLanguage.map(n => n.actionType).join(', ')}
                      </div>
                    </div>

                    {/* READ */}
                    <div className="bg-white rounded-lg p-4 border border-paradise-blue">
                      <div className="flex items-center gap-2 mb-2">
                        <div className="bg-paradise-blue text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs">
                          R
                        </div>
                        <h4 className="font-bold">READ (Analyze)</h4>
                      </div>
                      <div className="text-sm text-gray-700 mb-2">
                        Analyzers query ActionLanguage for patterns
                      </div>
                      <div className="text-xs bg-gray-50 p-2 rounded">
                        Detected {issues.length} issues: {issues.map(i => i.type).join(', ') || 'None'}
                      </div>
                    </div>

                    {/* UPDATE */}
                    <div className="bg-white rounded-lg p-4 border border-paradise-orange">
                      <div className="flex items-center gap-2 mb-2">
                        <div className="bg-paradise-orange text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs">
                          U
                        </div>
                        <h4 className="font-bold">UPDATE (Fix)</h4>
                      </div>
                      <div className="text-sm text-gray-700 mb-2">
                        Fix generators create new ActionLanguage nodes
                      </div>
                      <div className="text-xs bg-gray-50 p-2 rounded">
                        {issues.length > 0 ? `Ready to generate ${issues.length} fixes` : 'No fixes needed'}
                      </div>
                    </div>

                    {/* DELETE */}
                    <div className="bg-white rounded-lg p-4 border border-paradise-purple">
                      <div className="flex items-center gap-2 mb-2">
                        <div className="bg-paradise-purple text-white w-6 h-6 rounded-full flex items-center justify-center font-bold text-xs">
                          D
                        </div>
                        <h4 className="font-bold">DELETE (Optimize)</h4>
                      </div>
                      <div className="text-sm text-gray-700 mb-2">
                        Remove unused code and optimize
                      </div>
                      <div className="text-xs bg-gray-50 p-2 rounded">
                        Clean ActionLanguage ready for code generation
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Info Box */}
        <div className="mt-8 bg-paradise-blue/10 rounded-lg p-6 border border-paradise-blue/20">
          <h3 className="text-xl font-bold mb-3 text-paradise-blue">How This Works</h3>
          <div className="grid md:grid-cols-3 gap-6 text-sm">
            <div>
              <div className="font-semibold mb-2">üéØ Real-Time Analysis</div>
              <p className="text-gray-700">
                As you type, the playground parses your JavaScript to ActionLanguage and runs
                accessibility analyzers‚Äîjust like the VS Code extension.
              </p>
            </div>
            <div>
              <div className="font-semibold mb-2">üîç Pattern Detection</div>
              <p className="text-gray-700">
                Analyzers query the ActionLanguage tree for accessibility anti-patterns using
                simple tree traversal (no AI needed!).
              </p>
            </div>
            <div>
              <div className="font-semibold mb-2">üåç Universal</div>
              <p className="text-gray-700">
                These same analyzers work for JavaScript, Objective-C, Kotlin, and any language
                with a CREATE function.
              </p>
            </div>
          </div>
        </div>

        {/* Try Learning */}
        <div className="mt-8 bg-gradient-to-r from-paradise-blue to-paradise-purple text-white rounded-lg p-8 text-center">
          <h3 className="text-2xl font-bold mb-3">Want to Learn More?</h3>
          <p className="text-lg mb-6">
            Explore our comprehensive modules to understand ActionLanguage and build your own analyzers.
          </p>
          <div className="flex gap-4 justify-center">
            <a href="/learn-actionlanguage" className="bg-white text-paradise-blue px-6 py-3 rounded-lg font-semibold hover:bg-gray-100 transition-colors">
              Start Learning
            </a>
            <a href="/extension" className="bg-paradise-green text-white px-6 py-3 rounded-lg font-semibold hover:bg-paradise-green/90 transition-colors">
              Get VS Code Extension
            </a>
          </div>
        </div>
      </section>
    </main>
  );
}
